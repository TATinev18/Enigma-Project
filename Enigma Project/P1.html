<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="MultiPlayerGame.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <script src="map.js"></script>
    <script src="P1.js"></script>
</head>

<body>
    <p id="error"></p>
    <div id="search">
        <form action="javascript:findMatch(this.value)">
            <p>Select side</p>
            <input type="radio" id="Germans" name="side" value="German">
            <label for="Germans">Germans</label><br>
            <input type="radio" id="Great Britain" name="side" value="British">
            <label for="Great Britain">Britains</label><br>
            <input type="text" id="user" placeholder="username">
            <input type="submit" value="Unranked">
        </form>
    </div>
    <div id="fleet" style="display: none;">
        <div>
            <span id="planeDisplay">0</span>
            <button id="plane-" onclick="changeUtilityValues('planeDisplay','planeCost','-',250)"><</button>
            <button id="plane+" onclick="changeUtilityValues('planeDisplay','planeCost','+',250)">></button>

            <span id="planeCost">0</span>
        </div>
        <div>
            <span id="shipDisplay">0</span>
            <button id="ship-" onclick="changeUtilityValues('shipDisplay','shipCost','-',150)">< </button>
            <button id="ship+" onclick="changeUtilityValues('shipDisplay','shipCost','+',150)">></button>
            <span id="shipCost">0</span>
        </div>
        <div>
            <span id="LCDisplay">0</span>
            <button id="LC-" onclick="changeUtilityValues('LCDisplay','LCCost','-',125)">< </button>
            <button id="LC+" onclick="changeUtilityValues('LCDisplay','LCCost','+',125)">></button>
            <span id="LCCost">0</span>
        </div>
        <button id="createFarm" onclick="createFarm()">create farm (200 gold)</button>
        <button id="sendFleet" onclick="sendFleet()">send</button> <span id="total">0</span>
    </div>
    <div id="game" style="display:none">
        <span id="currency">Gold: 0</span>
        <form>
            <input type="text" id="send" placeholder="chat">
            <input type="text" id="input" placeholder="input">
        </form>
        <div id="Map"></div>
        <button onclick="chat(document.getElementById('send').value);">send chat</button>
        <button id="setCode" onclick="setCode()">Set Code</button>
        <button id="guess" onclick="guess()">guess</button>
        <button id="scan" onclick="scan()">use scan (-10)</button>
        <button id="ET" onclick="endTurn()">End Turn</button>
        <div id="Map"></div>
        <p id="points"></p>
        <div id="history">
            <p id="1"></p>
            <p id="2"></p>
            <p id="3"></p>
            <p id="4"></p>
            <p id="5"></p>
            <p id="6"></p>
            <p id="7"></p>
            <p id="8"></p>
            <p id="9"></p>
            <p id="10"></p>
            <p id="11"></p>
            <p id="12"></p>
            <p id="13"></p>
        </div>
        <p id="victory"></p>
        <div id="chatbox"></div>
    </div>
</body>
<script>
    document.getElementById("Map").innerHTML = gameMap;

    var socket;
    function changeUtilityValues(id,priceId ,operation,priceUnit) {
        let value = parseInt(document.getElementById(id).innerHTML);
        let price = parseInt(document.getElementById(priceId).innerHTML);
        if (operation=="+"){
            document.getElementById(id).innerHTML =value+1;
            document.getElementById(priceId).innerHTML =priceUnit*(value+1);
        }
        else{
            if (value-1>=0){
                document.getElementById(id).innerHTML = value-1 ;
                document.getElementById(priceId).innerHTML =priceUnit*(value-1);
            }
        }
        let planeCost = parseInt(document.getElementById("planeCost").innerHTML);
        let shipCost = parseInt(document.getElementById("shipCost").innerHTML);
        let LCCost = parseInt(document.getElementById("LCCost").innerHTML);
        document.getElementById("total").innerHTML =(planeCost+shipCost+LCCost);
    }
    function findMatch() {
        let side = document.querySelector('[name="side"]:checked');
        let user = document.getElementById("user").value;

        let data = {
            side: side.value,
            matchType: "unranked",
            user: user
        };

        socket = io('http://localhost:8080');
        socket.emit("matchMake", data);

        socket.on("begin", () => {
            console.log("beggining");
            $('#search').css('display', 'none');
            $('#game').css('display', 'block');
            $("#fleet").css("display","block");
            
            socket.emit("side", side.value);
            hideElements(side.value);
            updateCurrency();
        });

        socket.on("chat", (msg) => {
            $('#chatbox').html($('#chatbox').html() + '<p>' + msg.user + ': ' + msg.msg);
        });

        socket.on("beginTurn", () => {
            beginTurn();
            updateCurrency();
        });

        socket.on("endTurn", () => {
            endTurn();
            updateCurrency();
        });

        socket.on("fleetResult",(msg)=>{
            console.log(msg);
            updateCurrency();
        });

        socket.on("scanResult",(msg)=>{
            console.log(msg);
            updateCurrency();
        });

        socket.on("farmResult",(msg)=>{
            console.log(msg);
        });
        socket.on("updateCurrency", (currency)=> {
            if(data.side=="British")
                $("#currency").text("Points: "+currency);
            if(data.side=="German")
                $("#currency").text("Gold: "+currency);
        });
        socket.on("forceTurn", ()=> {
            $("#ET").attr("disabled",true);
        });

        socket.on("error", (data)=>{
            $("#error").text(data.err);
        });
        socket.on("history", (history)=>{
            $("#input").attr("disabled",true);
            $("#guess").attr("disabled",true);
            displayHistory(history);
            updateCurrency();
        });
        socket.on("victory",(data)=>{
            console.log(data);
            if(data.victory=="GERMAN") {
                $("#victory").text("Germany wins");
            }
            if(data.victory=="BRITISH") {
                $("#victory").text("Britain wins");
            }
            $("#input").attr("disabled", true);
            $("#guess").attr("disabled", true);
            $("#ET").attr("disabled", true);
            $("#scan").attr("disabled", true);
        });
    }

    function chat(msg) {
        console.log(socket);
        console.log(msg);
        $("#send").val("");
        socket.emit("chat", msg);
    }

    function guess() {
        let nums = extractNumbers();
        socket.emit("guess", nums);
    }

    function endTurn() {
        $("#input").attr("disabled", true);
        $("#guess").attr("disabled", true);
        $("#ET").attr("disabled", true);
        $("#scan").attr("disabled", true);
        lockFleetMenu(1);
        socket.emit("endTurn");
    }

    function beginTurn() {
        $("#input").attr("disabled", false);
        $("#guess").attr("disabled", false);
        $("#ET").attr("disabled", false);
        $("#scan").attr("disabled", false);
        lockFleetMenu(2);
    }

    function sendFleet() {
        let fleet = {
            plane: $("#planeDisplay").text(),
            ship:  $("#shipDisplay").text(),
            LC:    $("#LCDisplay").text(),
            farm:  $("#farmDisplay").text(),
            price: $("#total").text()
        };
        console.log("emit");
        socket.emit("fleet",fleet);
    }
</script>

</html>
