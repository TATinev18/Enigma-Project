<!DOCTYPE html>
<html lang="en">

<head>
    <title>Title</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script src="MultiPlayerGame.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <script src="../js/map.js"></script>
    <script src="../js/Client.js"></script>
    <script src="../js/secrets.js"></script>
</head>

<body>
    <div class="bg_image_secondary fade-in-animation" style="height: 100%;">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarTogglerDemo01">

                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="login.html">Login</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container" class="container" style="background-color: rgba(87, 87, 92, 0.863);padding: 1%;height: 94%;">
            <p id="error"></p>

            <div id="search">
                    <div class="row" style="position: absolute;top: 18%;left: 20%;">
                        <h2 class="display-5">
                            <p><strong>Select side</strong></p>
                        </h2>
                    </div>

                    <div class="container" style="position: absolute;top: 25%;left: 20%;">
                        <span style="display: inline-flex;">
                            <form>
                            <div class="form-group mx-sm-1 mb-3">

                            <input type="text" class="form-control" id="user" placeholder="username">
                        </div>
                    </form>
                        </span><span style="display: inline-flex;">
                            <button onclick="playUnranked()" id="unrankedButton" class="btn btn-primary mb-2" disabled>Play Unranked</button>
                            <button onclick="playRanked()" id="rankedButton" class="btn btn-primary mb-2" disabled>Play Ranked</button>
                        </span>
                        <br>
                        <div class="row">

                            <div class="col-md-4">
                                <div class="text-center"><img id="germanSide" src="../photos/germanySide.png"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center"><img id="britishSide" src="../photos/britainSide.png"></div>
                            </div>
                        </div>
                    </div>
            </div>

            <div id="fleet" style="display: none;">
                <div>
                    <span id="planeDisplay">0</span>
                    <button id="plane-" onclick="changeUtilityValues('planeDisplay','planeCost','-',150)"><</button>
                    <button id="plane+" onclick="changeUtilityValues('planeDisplay','planeCost','+',150)">></button>

                    <span id="planeCost">0</span>
                </div>
                <div>
                    <span id="shipDisplay">0</span>
                    <button id="ship-" onclick="changeUtilityValues('shipDisplay','shipCost','-',250)">< </button>
                    <button id="ship+" onclick="changeUtilityValues('shipDisplay','shipCost','+',250)">></button>
                    <span id="shipCost">0</span>
                </div>
                <div>
                    <span id="LCDisplay">0</span>
                    <button id="LC-" onclick="changeUtilityValues('LCDisplay','LCCost','-',125)">< </button>
                    <button id="LC+" onclick="changeUtilityValues('LCDisplay','LCCost','+',125)">></button>
                    <span id="LCCost">0</span>
                </div>
                <button id="createFarm">"Create Farm ( 200 G )"</button>
                <button id="sendFleet" onclick="sendFleet()" disabled>send</button> <span id="total">0</span>
            </div>
            <div id="game" style="display:none">
                <span id="currency">Gold: 0</span>
                <form>
                    <input type="text" id="send" placeholder="chat">
                    <input type="text" id="input" placeholder="input">
                </form>
                <div id="Map"></div>
                <button onclick="chat(document.getElementById('send').value);">send chat</button>
                <button id="setCode" onclick="setCode()">Set Code</button>
                <button id="guess" onclick="guess()">guess</button>
                <button id="scan">Scan province for farm ( -10P );</button>
                <button id="ET" onclick="endTurn()">End Turn</button>

                <div id="Map"></div>

                <p id="points"></p>

                <div id="history"></div>

                <p id="victory"></p>

                <div id="chatbox"></div>

            </div>
        </div>

    </div>
</body>

<script>
    document.getElementById("Map").innerHTML = gameMap;

    var socket;

    function changeUtilityValues(id, priceId, operation, priceUnit) {
        let value = parseInt(document.getElementById(id).innerHTML);
        let price = parseInt(document.getElementById(priceId).innerHTML);
        if (operation == "+") {
            document.getElementById(id).innerHTML = value + 1;
            document.getElementById(priceId).innerHTML = priceUnit * (value + 1);
        } else {
            if (value - 1 >= 0) {
                document.getElementById(id).innerHTML = value - 1;
                document.getElementById(priceId).innerHTML = priceUnit * (value - 1);
            }
        }
        let planeCost = parseInt(document.getElementById("planeCost").innerHTML);
        let shipCost = parseInt(document.getElementById("shipCost").innerHTML);
        let LCCost = parseInt(document.getElementById("LCCost").innerHTML);
        let total = planeCost + shipCost + LCCost;
        document.getElementById("total").innerHTML = (total);
        if(total>0) $("#sendFleet").attr("disabled",false);
        else $("#sendFleet").attr("disabled",true);
    }

        let side = {};
        let bs = $("#britishSide");
        let gs = $("#germanSide");
        gs.on("click",()=>{
            enableClick(gs);
            enableHover(bs);
            console.log("german");
            side.value = "German";
            
        });
        bs.on("click",() => {
            enableClick(bs);
            enableHover(gs);
            console.log("bri");
            side.value = "British"
            
        });

    $("#rankedButton").on("click",()=>{
        var $foo = $(this);
        if (!$foo.data('clicked')) {
            gs.attr("src","../photos/germanySideLock.png").off("mouseenter").off("mouseleave").off("click");
            bs.attr("src","../photos/britainSideLock.png").off("mouseenter").off("mouseleave").off("click");
            gs.css("cursor","auto");
            bs.css("cursor","auto");
            $("#rankedButton").text("Cancel");
            $("#unrankedButton").attr("disabled",true);
            findMatch("ranked");
            $foo.data("clicked",true);
        } else {
            gs.attr("src","../photos/germanySide.png");
            bs.attr("src","../photos/britainSide.png");
            $("#rankedButton").text("Play Ranked");
            $("#unrankedButton").attr("disabled",false);

            enableHover(bs);
            enableHover(gs);

            gs.on("click",()=>{
            enableClick(gs);
            enableHover(bs);
            console.log("german");
            side.value = "German";
            });
            bs.on("click",() => {
            enableClick(bs);
            enableHover(gs);
            console.log("bri");
            side.value = "British"
            });

            $foo.data("clicked",false);
            socket.emit("cancel",{id:socket.id});
            socket.disconnect();
        }
    });

    $("#unrankedButton").on("click",()=>{
        var $foo = $(this);
        if (!$foo.data('clicked')) {
            gs.attr("src","../photos/germanySideLock.png").off("mouseenter").off("mouseleave").off("click");
            bs.attr("src","../photos/britainSideLock.png").off("mouseenter").off("mouseleave").off("click");
            gs.css("cursor","auto");
            bs.css("cursor","auto");
            $("#unrankedButton").text("Cancel");
            $("#rankedButton").attr("disabled",true);
            findMatch("unranked");
            $foo.data("clicked",true);
        } else {
            gs.attr("src","../photos/germanySide.png");
            bs.attr("src","../photos/britainSide.png");
            $("#unrankedButton").text("Play Ranked");
            $("#rankedButton").attr("disabled",false);

            enableHover(bs);
            enableHover(gs);

            gs.on("click",()=>{
            enableClick(gs);
            enableHover(bs);
            console.log("german");
            side.value = "German";
            });
            bs.on("click",() => {
            enableClick(bs);
            enableHover(gs);
            console.log("bri");
            side.value = "British"
            });

            $foo.data("clicked",false);
            socket.emit("cancel",{id:socket.id});
            socket.disconnect();
        }
    });

    function findMatch(rank) {
        let user = document.getElementById("user").value;
        
        let data = {
            side: side.value,
            matchType: rank,
            user: user
        };

        //socket = io('http://' + IP_ADDRESS + ':' + PORT);
        socket = io('http://localhost:8080');
        socket.emit("matchMake", data);

        socket.on("begin", () => {
            console.log("beggining");
            $('#search').css('display', 'none');
            $('#game').css('display', 'block');
            $("#fleet").css("display", "block");

            socket.emit("side", side.value);
            hideElements(side.value);
            updateCurrency();
        });

        socket.on("chat", (msg) => {
            $('#chatbox').html($('#chatbox').html() + '<p>' + msg.user + ': ' + msg.msg);
        });

        socket.on("beginTurn", () => {
            beginTurn();
            updateCurrency();
        });

        socket.on("endTurn", () => {
            endTurn();
            updateCurrency();
        });

        socket.on("fleetResult", (msg) => {
            console.log(msg);
            updateCurrency();
        });

        socket.on("scanResult", (msg) => {
            console.log(msg);
            updateCurrency();
        });

        socket.on("farmResult", (msg) => {
            console.log(msg);
        });
        socket.on("updateCurrency", (currency) => {
            if (data.side == "British")
                $("#currency").text("Points: " + currency);
            if (data.side == "German")
                $("#currency").text("Gold: " + currency);
        });
        socket.on("forceTurn", () => {
            $("#ET").attr("disabled", true);
        });

        socket.on("error", (data) => {
            $("#error").text(data.err);
        });
        socket.on("history", (history) => {
            $("#input").attr("disabled", true);
            $("#guess").attr("disabled", true);
            displayHistory(history);
            updateCurrency();
        });
        //socket.on("receiveProvinces",(provinces)=>{
        //    displayUsedProvinces(provinces);
        //})
        socket.on("victory", (data) => {
            console.log(data);
            if (data.victory == "GERMAN") {
                $("#victory").text("Germany wins");
            }
            if (data.victory == "BRITISH") {
                $("#victory").text("Britain wins");
            }
            $("#input").attr("disabled", true);
            $("#guess").attr("disabled", true);
            $("#ET").attr("disabled", true);
            $("#scan").attr("disabled", true);
        });
    }

    function chat(msg) {
        console.log(socket);
        console.log(msg);
        $("#send").val("");
        socket.emit("chat", msg);
    }

    function guess() {
        let nums = extractNumbers();
        socket.emit("guess", nums);
    }

    function endTurn() {
        $("#input").attr("disabled", true);
        $("#guess").attr("disabled", true);
        $("#ET").attr("disabled", true);
        $("#scan").attr("disabled", true);
        $("#createFarm").data("clicked", false);
        $("#scan").data("clicked", false);
        deselectFarm();
        deselectScan();
        lockFleetMenu(1);
        socket.emit("endTurn");
    }

    function beginTurn() {
        $("#input").attr("disabled", false);
        $("#guess").attr("disabled", false);
        $("#ET").attr("disabled", false);
        $("#scan").attr("disabled", false);
        lockFleetMenu(2);
    }

    function sendFleet() {
        let fleet = {
            plane: $("#planeDisplay").text(),
            ship: $("#shipDisplay").text(),
            LC: $("#LCDisplay").text(),
            farm: $("#farmDisplay").text(),
            price: $("#total").text()
        };
        console.log("emit");
        socket.emit("fleet", fleet);
    }

    function enableClick(element) {
        $("#unrankedButton").attr("disabled",false);
        $("#rankedButton").attr("disabled",false);
        element.off("mouseenter").off("mouseleave").css("cursor","auto").css("transform", "scale(1.05)")
        if(element==gs)
            element.css("box-shadow", "0 4px 8px 0 rgb(163, 33, 33), 0 6px 20px 0 rgb(163, 33, 33)");
        else
            element.css("box-shadow", "0 4px 8px 0 rgb(32, 80, 184), 0 6px 20px 0 rgb(32, 80, 184)");
    }

    function enableHover(element) {
        element.css("transform", "scale(1)")
        .css("box-shadow", "0 4px 8px 0 rgb(0, 0, 0), 0 6px 20px 0 rgb(0, 0, 0)")
        .on({
            mouseenter:()=>{
                element.css("transform", "scale(1.05)").css("cursor","pointer");
                if(element==gs)
                    element.css("box-shadow", "0 4px 8px 0 rgb(163, 33, 33), 0 6px 20px 0 rgb(163, 33, 33)");
                else
                    element.css("box-shadow", "0 4px 8px 0 rgb(32, 80, 184), 0 6px 20px 0 rgb(32, 80, 184)");
                    
            },
            mouseleave:()=>{
                element.css("transform", "scale(1)")
                .css("box-shadow", "0 4px 8px 0 rgb(0, 0, 0), 0 6px 20px 0 rgb(0, 0, 0)")
                .css("cursor","auto");
            }
        });
    }

    $('#createFarm').click(function() {
        var $foo = $(this);
        if (!$foo.data('clicked')) {
            createFarm();
        } else {
            deselectFarm();
        }
    });

    $('#scan').click(function() {
        var $foo = $(this);
        if (!$foo.data('clicked')) {
            scan()
        } else {
            deselectScan();
        }
    });
</script>

</html>